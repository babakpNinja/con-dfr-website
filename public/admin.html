<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel - CON-DFR</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Vazirmatn:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      text-align: center;
    }
    .stat-card h3 {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }
    .stat-card p {
      color: var(--text-muted);
      font-size: 0.875rem;
      margin: 0;
    }
    .search-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    .search-bar input {
      flex: 1;
      min-width: 200px;
    }
    .search-bar select {
      min-width: 150px;
    }
    .membership-detail {
      background: var(--bg-secondary);
      padding: 1.5rem;
      border-radius: var(--border-radius);
      margin-bottom: 1rem;
    }
    .membership-detail h4 {
      margin-bottom: 1rem;
      color: var(--primary-color);
    }
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    .detail-item label {
      display: block;
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }
    .detail-item p {
      margin: 0;
      color: var(--text-primary);
    }
    .global-search {
      position: relative;
      margin-bottom: 1rem;
    }
    .global-search input {
      width: 100%;
      padding: 1rem 1rem 1rem 3rem;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 1rem;
    }
    .global-search svg {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      max-height: 400px;
      overflow-y: auto;
      z-index: 100;
      display: none;
    }
    .search-results.show {
      display: block;
    }
    .search-result-item {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .search-result-item:hover {
      background: var(--bg-secondary);
    }
    .search-result-item:last-child {
      border-bottom: none;
    }
    .result-type {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: var(--bg-secondary);
    }
    .result-type.partner { background: #e3f2fd; color: #1976d2; }
    .result-type.membership { background: #f3e5f5; color: #7b1fa2; }
    
    /* Spin animation for loading */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .spin {
      animation: spin 1s linear infinite;
    }
    #auto-translate-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      transition: all 0.3s ease;
    }
    #auto-translate-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    #auto-translate-btn:disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
<script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
</head>
<body>
  <!-- Login Screen -->
  <div class="admin-login" id="login-screen">
    <div class="login-card">
      <h2>üîê Admin Login</h2>
      <div id="login-alert"></div>
      <form id="login-form">
        <div class="form-group">
          <label for="username">Username</label>
          <input type="text" id="username" class="form-control" placeholder="Enter username" required>
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" class="form-control" placeholder="Enter password" required>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%">Login</button>
      </form>
      <p style="text-align: center; margin-top: 1.5rem; color: var(--text-muted);">
        <a href="/" style="color: var(--primary-color);">‚Üê Back to Website</a>
      </p>
    </div>
  </div>

  <!-- Admin Dashboard -->
  <div class="admin-container hidden" id="admin-dashboard">
    <aside class="admin-sidebar" id="admin-sidebar">
      <div class="admin-logo">
        <h3>üèõÔ∏è CON-DFR Admin</h3>
      </div>
      <ul class="admin-nav">
        <li>
          <a href="#" class="active" data-section="partners">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="9" cy="7" r="4"/>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
            </svg>
            Partners
          </a>
        </li>
        <li>
          <a href="#" data-section="memberships">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
              <circle cx="8.5" cy="7" r="4"/>
              <line x1="20" y1="8" x2="20" y2="14"/>
              <line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            Memberships
            <span id="pending-badge" class="status-badge status-active" style="margin-left: auto; font-size: 0.7rem;">0</span>
          </a>
        </li>
        <li>
          <a href="#" data-section="settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
            Settings
          </a>
        </li>
        <li>
          <a href="/" target="_blank">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
              <polyline points="15 3 21 3 21 9"/>
              <line x1="10" y1="14" x2="21" y2="3"/>
            </svg>
            View Website
          </a>
        </li>
        <li>
          <a href="#" id="logout-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
              <polyline points="16 17 21 12 16 7"/>
              <line x1="21" y1="12" x2="9" y2="12"/>
            </svg>
            Logout
          </a>
        </li>
      </ul>
    </aside>

    <main class="admin-main">
      <!-- Global Search -->
      <div class="global-search">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <input type="text" id="global-search" placeholder="Search partners, memberships, emails..." autocomplete="off">
        <div class="search-results" id="search-results"></div>
      </div>

      <!-- Partners Section -->
      <section id="section-partners">
        <div class="admin-header">
          <h1>üë• Partners Management</h1>
          <button class="btn btn-primary" id="add-partner-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"/>
              <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Partner
          </button>
        </div>
        
        <div id="partners-alert"></div>
        
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Name (EN)</th>
                <th>Type</th>
                <th>Status</th>
                <th>Order</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="partners-table-body">
              <tr><td colspan="6" style="text-align: center; padding: 2rem;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Memberships Section -->
      <section id="section-memberships" class="hidden">
        <div class="admin-header">
          <h1>üìã Membership Applications</h1>
        </div>
        
        <div class="stats-grid" id="membership-stats">
          <div class="stat-card">
            <h3 id="stat-total">0</h3>
            <p>Total Applications</p>
          </div>
          <div class="stat-card">
            <h3 id="stat-pending" style="color: var(--warning-color);">0</h3>
            <p>Pending Review</p>
          </div>
          <div class="stat-card">
            <h3 id="stat-approved" style="color: var(--success-color);">0</h3>
            <p>Approved</p>
          </div>
          <div class="stat-card">
            <h3 id="stat-rejected" style="color: var(--danger-color);">0</h3>
            <p>Rejected</p>
          </div>
        </div>
        
        <div id="memberships-alert"></div>
        
        <div class="search-bar">
          <input type="text" id="membership-search" class="form-control" placeholder="Search by name, email, country, skills...">
          <select id="membership-status-filter" class="form-control">
            <option value="all">All Status</option>
            <option value="pending">Pending</option>
            <option value="approved">Approved</option>
            <option value="rejected">Rejected</option>
          </select>
          <select id="membership-type-filter" class="form-control">
            <option value="all">All Types</option>
            <option value="individual">Individuals</option>
            <option value="organization">Organizations</option>
          </select>
          <button class="btn btn-primary" onclick="searchMemberships()">Search</button>
        </div>
        
        <div class="admin-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Type</th>
                <th>Membership</th>
                <th>Country</th>
                <th>Status</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="memberships-table-body">
              <tr><td colspan="8" style="text-align: center; padding: 2rem;">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Settings Section -->
      <section id="section-settings" class="hidden">
        <div class="admin-header">
          <h1>‚öôÔ∏è Settings</h1>
        </div>
        
        <div style="max-width: 500px;">
          <div class="admin-table-container" style="padding: 2rem;">
            <h3 style="margin-bottom: 1.5rem;">Change Password</h3>
            <div id="settings-alert"></div>
            <form id="change-password-form">
              <div class="form-group">
                <label for="current-password">Current Password</label>
                <input type="password" id="current-password" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" class="form-control" required>
              </div>
              <div class="form-group">
                <label for="confirm-password">Confirm New Password</label>
                <input type="password" id="confirm-password" class="form-control" required>
              </div>
              <button type="submit" class="btn btn-primary">Update Password</button>
            </form>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Partner Modal -->
  <div class="modal-overlay" id="partner-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="modal-title">Add Partner</h3>
        <button class="modal-close" id="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <form id="partner-form">
          <input type="hidden" id="partner-id">
          
          <div class="form-grid">
            <div class="form-group">
              <label for="partner-type">Partner Type</label>
              <select id="partner-type" class="form-control">
                <option value="organization">Organization</option>
                <option value="individual">Individual</option>
              </select>
            </div>
            <div class="form-group">
              <label for="partner-order">Display Order</label>
              <input type="number" id="partner-order" class="form-control" value="0">
            </div>
            <div class="form-group">
              <label for="partner-website">Website URL</label>
              <input type="url" id="partner-website" class="form-control" placeholder="https://...">
            </div>
            <div class="form-group">
              <label for="partner-image-url">Image URL</label>
              <input type="url" id="partner-image-url" class="form-control" placeholder="https://...">
            </div>
            <div class="form-group full-width">
              <label for="partner-image">Or Upload Image</label>
              <input type="file" id="partner-image" class="form-control" accept="image/*">
            </div>
            <div class="form-group">
              <label><input type="checkbox" id="partner-active" checked> Active</label>
            </div>
          </div>
          
          <div class="modal-tabs">
            <button type="button" class="modal-tab active" data-lang="en">üá¨üáß EN</button>
            <button type="button" class="modal-tab" data-lang="fa">üáÆüá∑ FA</button>
            <button type="button" class="modal-tab" data-lang="tr">üáπüá∑ TR</button>
            <button type="button" class="modal-tab" data-lang="az">üá¶üáø AZ</button>
            <button type="button" class="modal-tab" data-lang="ar">üá∏üá¶ AR</button>
            <button type="button" class="modal-tab" data-lang="zh">üá®üá≥ ZH</button>
            <button type="button" class="modal-tab" data-lang="es">üá™üá∏ ES</button>
          </div>
          
          <div class="tab-content active" data-lang="en">
            <div class="form-group"><label>Name (English) *</label><input type="text" id="name-en" class="form-control" required></div>
            <div class="form-group"><label>Description</label><textarea id="desc-en" class="form-control" rows="3"></textarea></div>
            <button type="button" class="btn btn-secondary" id="auto-translate-btn" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M5 8l6 6M4 14l6-6 2-3M2 5h12M7 2v3M22 22l-5-10-5 10M14 18h6"/>
              </svg>
              Auto-Translate to All Languages
            </button>
            <div id="translate-status" style="margin-top: 0.5rem; font-size: 0.875rem; color: var(--text-muted);"></div>
          </div>
          <div class="tab-content" data-lang="fa">
            <div class="form-group"><label>Name (ŸÅÿßÿ±ÿ≥€å)</label><input type="text" id="name-fa" class="form-control" dir="rtl"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-fa" class="form-control" rows="3" dir="rtl"></textarea></div>
          </div>
          <div class="tab-content" data-lang="tr">
            <div class="form-group"><label>Name (T√ºrk√ße)</label><input type="text" id="name-tr" class="form-control"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-tr" class="form-control" rows="3"></textarea></div>
          </div>
          <div class="tab-content" data-lang="az">
            <div class="form-group"><label>Name (Az…ôrbaycan)</label><input type="text" id="name-az" class="form-control"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-az" class="form-control" rows="3"></textarea></div>
          </div>
          <div class="tab-content" data-lang="ar">
            <div class="form-group"><label>Name (ÿßŸÑÿπÿ±ÿ®Ÿäÿ©)</label><input type="text" id="name-ar" class="form-control" dir="rtl"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-ar" class="form-control" rows="3" dir="rtl"></textarea></div>
          </div>
          <div class="tab-content" data-lang="zh">
            <div class="form-group"><label>Name (‰∏≠Êñá)</label><input type="text" id="name-zh" class="form-control"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-zh" class="form-control" rows="3"></textarea></div>
          </div>
          <div class="tab-content" data-lang="es">
            <div class="form-group"><label>Name (Espa√±ol)</label><input type="text" id="name-es" class="form-control"></div>
            <div class="form-group"><label>Description</label><textarea id="desc-es" class="form-control" rows="3"></textarea></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="modal-cancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="modal-save">Save Partner</button>
      </div>
    </div>
  </div>

  <!-- Membership Detail Modal -->
  <div class="modal-overlay" id="membership-modal">
    <div class="modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>Membership Application Details</h3>
        <button class="modal-close" onclick="closeMembershipModal()">&times;</button>
      </div>
      <div class="modal-body" id="membership-detail-content"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="closeMembershipModal()">Close</button>
        <button type="button" class="btn btn-secondary" onclick="updateMembershipStatus('rejected')">Reject</button>
        <button type="button" class="btn btn-primary" onclick="updateMembershipStatus('approved')">Approve</button>
      </div>
    </div>
  </div>

  <!-- Delete Modal -->
  <div class="modal-overlay" id="delete-modal">
    <div class="modal" style="max-width: 400px;">
      <div class="modal-header">
        <h3>‚ö†Ô∏è Confirm Delete</h3>
        <button class="modal-close" id="delete-modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this? This action cannot be undone.</p>
        <input type="hidden" id="delete-id">
        <input type="hidden" id="delete-type">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="delete-cancel">Cancel</button>
        <button type="button" class="btn btn-secondary" id="delete-confirm">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let currentMembershipId = null;
    let currentPartnerId = null;
    let isEditing = false;

    const loginScreen = document.getElementById('login-screen');
    const adminDashboard = document.getElementById('admin-dashboard');
    const partnerModal = document.getElementById('partner-modal');
    const membershipModal = document.getElementById('membership-modal');
    const deleteModal = document.getElementById('delete-modal');

    document.addEventListener('DOMContentLoaded', () => {
      checkAuth();
      initEventListeners();
    });

    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/status');
        const data = await response.json();
        if (data.isAuthenticated) {
          showDashboard();
          loadPartners();
          loadMembershipStats();
        } else {
          showLogin();
        }
      } catch (error) {
        showLogin();
      }
    }

    function showLogin() {
      loginScreen.classList.remove('hidden');
      adminDashboard.classList.add('hidden');
    }

    function showDashboard() {
      loginScreen.classList.add('hidden');
      adminDashboard.classList.remove('hidden');
    }

    function initEventListeners() {
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('logout-btn').addEventListener('click', handleLogout);

      document.querySelectorAll('.admin-nav a[data-section]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const section = link.dataset.section;
          showSection(section);
          document.querySelectorAll('.admin-nav a').forEach(a => a.classList.remove('active'));
          link.classList.add('active');
          if (section === 'memberships') {
            loadMemberships();
            loadMembershipStats();
          }
        });
      });

      document.getElementById('add-partner-btn').addEventListener('click', () => openPartnerModal());
      document.getElementById('modal-close').addEventListener('click', closePartnerModal);
      document.getElementById('modal-cancel').addEventListener('click', closePartnerModal);
      document.getElementById('modal-save').addEventListener('click', savePartner);
      document.getElementById('auto-translate-btn').addEventListener('click', autoTranslate);

      document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const lang = tab.dataset.lang;
          document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          document.querySelectorAll('.tab-content').forEach(c => c.classList.toggle('active', c.dataset.lang === lang));
        });
      });

      document.getElementById('delete-modal-close').addEventListener('click', closeDeleteModal);
      document.getElementById('delete-cancel').addEventListener('click', closeDeleteModal);
      document.getElementById('delete-confirm').addEventListener('click', confirmDelete);
      document.getElementById('change-password-form').addEventListener('submit', handleChangePassword);

      let searchTimeout;
      document.getElementById('global-search').addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => performGlobalSearch(e.target.value), 300);
      });

      document.getElementById('global-search').addEventListener('focus', () => {
        if (document.getElementById('global-search').value.length >= 2) 
          document.getElementById('search-results').classList.add('show');
      });

      document.addEventListener('click', (e) => {
        if (!e.target.closest('.global-search')) 
          document.getElementById('search-results').classList.remove('show');
      });

      document.getElementById('membership-search').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') searchMemberships();
      });

      [partnerModal, membershipModal, deleteModal].forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.classList.remove('show');
        });
      });
    }

    async function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await response.json();

        if (data.success) {
          showDashboard();
          loadPartners();
          loadMembershipStats();
        } else {
          showAlert(document.getElementById('login-alert'), data.message || 'Invalid credentials', 'error');
        }
      } catch (error) {
        showAlert(document.getElementById('login-alert'), 'Login failed', 'error');
      }
    }

    async function handleLogout(e) {
      e.preventDefault();
      await fetch('/api/logout', { method: 'POST' });
      showLogin();
    }

    function showSection(sectionId) {
      document.querySelectorAll('[id^="section-"]').forEach(s => s.classList.add('hidden'));
      document.getElementById(`section-${sectionId}`).classList.remove('hidden');
    }

    async function loadPartners() {
      try {
        const response = await fetch('/api/admin/partners');
        if (!response.ok) throw new Error('Not authorized');
        const partners = await response.json();
        renderPartnersTable(partners);
      } catch (error) {
        document.getElementById('partners-table-body').innerHTML = '<tr><td colspan="6" style="text-align:center;color:red;">Error loading partners. Please login again.</td></tr>';
      }
    }

    function renderPartnersTable(partners) {
      const tbody = document.getElementById('partners-table-body');
      if (partners.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No partners found.</td></tr>';
        return;
      }
      tbody.innerHTML = partners.map(p => `
        <tr>
          <td><img src="${p.image_url || 'https://via.placeholder.com/50'}" alt="${p.name_en}" style="width:50px;height:50px;object-fit:cover;border-radius:8px;" onerror="this.src='https://via.placeholder.com/50'"></td>
          <td><strong>${p.name_en}</strong>${p.name_fa ? `<br><small style="color:var(--text-muted)">${p.name_fa}</small>` : ''}</td>
          <td style="text-transform:capitalize">${p.partner_type}</td>
          <td><span class="status-badge ${p.is_active ? 'status-active' : 'status-inactive'}">${p.is_active ? 'Active' : 'Inactive'}</span></td>
          <td>${p.display_order}</td>
          <td>
            <div class="action-btns">
              <button class="action-btn action-btn-edit" onclick="editPartner(${p.id})" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn action-btn-toggle" onclick="togglePartner(${p.id})" title="Toggle">üëÅÔ∏è</button>
              <button class="action-btn action-btn-delete" onclick="deletePartner(${p.id})" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function openPartnerModal(partner = null) {
      isEditing = !!partner;
      currentPartnerId = partner ? partner.id : null;
      document.getElementById('modal-title').textContent = isEditing ? 'Edit Partner' : 'Add Partner';
      document.getElementById('partner-form').reset();

      document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));
      document.querySelector('.modal-tab[data-lang="en"]').classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.querySelector('.tab-content[data-lang="en"]').classList.add('active');

      if (partner) {
        document.getElementById('partner-id').value = partner.id;
        document.getElementById('partner-type').value = partner.partner_type || 'organization';
        document.getElementById('partner-order').value = partner.display_order || 0;
        document.getElementById('partner-website').value = partner.website_url || '';
        document.getElementById('partner-image-url').value = partner.image_url || '';
        document.getElementById('partner-active').checked = partner.is_active;

        ['en', 'fa', 'tr', 'az', 'ar', 'zh', 'es'].forEach(lang => {
          document.getElementById(`name-${lang}`).value = partner[`name_${lang}`] || '';
          document.getElementById(`desc-${lang}`).value = partner[`description_${lang}`] || '';
        });
      }
      partnerModal.classList.add('show');
    }

    function closePartnerModal() { partnerModal.classList.remove('show'); }

    async function autoTranslate() {
      const nameEn = document.getElementById('name-en').value.trim();
      const descEn = document.getElementById('desc-en').value.trim();
      
      if (!nameEn) {
        showAlert(document.getElementById('translate-status'), 'Please enter the English name first', 'error');
        return;
      }
      
      const btn = document.getElementById('auto-translate-btn');
      const statusEl = document.getElementById('translate-status');
      
      btn.disabled = true;
      btn.innerHTML = '<svg class="spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> Translating...';
      statusEl.textContent = 'Translating to all languages...';
      statusEl.style.color = 'var(--primary-color)';
      
      try {
        const response = await fetch('/api/admin/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: nameEn, description: descEn })
        });
        
        const data = await response.json();
        
        if (data.success && data.translations) {
          const t = data.translations;
          
          // Fill in all language fields
          document.getElementById('name-fa').value = t.name_fa || '';
          document.getElementById('desc-fa').value = t.description_fa || '';
          document.getElementById('name-tr').value = t.name_tr || '';
          document.getElementById('desc-tr').value = t.description_tr || '';
          document.getElementById('name-az').value = t.name_az || '';
          document.getElementById('desc-az').value = t.description_az || '';
          document.getElementById('name-ar').value = t.name_ar || '';
          document.getElementById('desc-ar').value = t.description_ar || '';
          document.getElementById('name-zh').value = t.name_zh || '';
          document.getElementById('desc-zh').value = t.description_zh || '';
          document.getElementById('name-es').value = t.name_es || '';
          document.getElementById('desc-es').value = t.description_es || '';
          
          statusEl.innerHTML = '‚úÖ Successfully translated to all 6 languages!';
          statusEl.style.color = 'var(--success-color)';
          
          // Flash the language tabs to indicate they're filled
          document.querySelectorAll('.modal-tab:not([data-lang="en"])').forEach(tab => {
            tab.style.background = 'var(--success-color)';
            tab.style.color = 'white';
            setTimeout(() => {
              tab.style.background = '';
              tab.style.color = '';
            }, 2000);
          });
        } else {
          throw new Error('Translation failed');
        }
      } catch (error) {
        statusEl.innerHTML = '‚ùå Translation failed. Please try again or enter manually.';
        statusEl.style.color = 'var(--danger-color)';
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 8l6 6M4 14l6-6 2-3M2 5h12M7 2v3M22 22l-5-10-5 10M14 18h6"/></svg> Auto-Translate to All Languages';
      }
    }

    async function savePartner() {
      const formData = new FormData();
      formData.append('partner_type', document.getElementById('partner-type').value);
      formData.append('display_order', document.getElementById('partner-order').value);
      formData.append('website_url', document.getElementById('partner-website').value);
      formData.append('image_url', document.getElementById('partner-image-url').value);
      formData.append('is_active', document.getElementById('partner-active').checked);

      const imageFile = document.getElementById('partner-image').files[0];
      if (imageFile) formData.append('image', imageFile);

      ['en', 'fa', 'tr', 'az', 'ar', 'zh', 'es'].forEach(lang => {
        formData.append(`name_${lang}`, document.getElementById(`name-${lang}`).value);
        formData.append(`description_${lang}`, document.getElementById(`desc-${lang}`).value);
      });

      try {
        const url = isEditing ? `/api/admin/partners/${currentPartnerId}` : '/api/admin/partners';
        const response = await fetch(url, { method: isEditing ? 'PUT' : 'POST', body: formData });
        const data = await response.json();
        if (data.success) {
          closePartnerModal();
          loadPartners();
          showAlert(document.getElementById('partners-alert'), `Partner ${isEditing ? 'updated' : 'created'}!`, 'success');
        }
      } catch (error) {
        showAlert(document.getElementById('partners-alert'), 'Error saving partner', 'error');
      }
    }

    async function editPartner(id) {
      const response = await fetch(`/api/partners/${id}`);
      const partner = await response.json();
      openPartnerModal(partner);
    }

    async function togglePartner(id) {
      await fetch(`/api/admin/partners/${id}/toggle`, { method: 'PATCH' });
      loadPartners();
    }

    function deletePartner(id) {
      document.getElementById('delete-id').value = id;
      document.getElementById('delete-type').value = 'partner';
      deleteModal.classList.add('show');
    }

    async function loadMemberships() {
      try {
        const response = await fetch('/api/admin/memberships');
        const memberships = await response.json();
        renderMembershipsTable(memberships);
      } catch (error) {
        document.getElementById('memberships-table-body').innerHTML = '<tr><td colspan="8" style="text-align:center;color:red;">Error loading</td></tr>';
      }
    }

    async function loadMembershipStats() {
      try {
        const response = await fetch('/api/admin/memberships/stats');
        const stats = await response.json();
        document.getElementById('stat-total').textContent = stats.total;
        document.getElementById('stat-pending').textContent = stats.pending;
        document.getElementById('stat-approved').textContent = stats.approved;
        document.getElementById('stat-rejected').textContent = stats.rejected;
        document.getElementById('pending-badge').textContent = stats.pending;
      } catch (error) {}
    }

    async function searchMemberships() {
      const search = document.getElementById('membership-search').value;
      const status = document.getElementById('membership-status-filter').value;
      const type = document.getElementById('membership-type-filter').value;

      const params = new URLSearchParams();
      if (search) params.append('search', search);
      if (status !== 'all') params.append('status', status);
      if (type !== 'all') params.append('type', type);

      const response = await fetch(`/api/admin/memberships?${params}`);
      const memberships = await response.json();
      renderMembershipsTable(memberships);
    }

    function renderMembershipsTable(memberships) {
      const tbody = document.getElementById('memberships-table-body');
      if (memberships.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No applications found.</td></tr>';
        return;
      }
      tbody.innerHTML = memberships.map(m => `
        <tr>
          <td><strong>${m.full_name}</strong>${m.organization_name ? `<br><small>${m.organization_name}</small>` : ''}</td>
          <td>${m.email}</td>
          <td style="text-transform:capitalize">${m.applicant_type}</td>
          <td style="text-transform:capitalize">${m.membership_type}</td>
          <td>${m.country || '-'}</td>
          <td><span class="status-badge ${m.status === 'approved' ? 'status-active' : m.status === 'rejected' ? 'status-inactive' : ''}" style="${m.status === 'pending' ? 'background:#fff3cd;color:#856404;' : ''}">${m.status}</span></td>
          <td>${new Date(m.created_at).toLocaleDateString()}</td>
          <td>
            <div class="action-btns">
              <button class="action-btn action-btn-edit" onclick="viewMembership(${m.id})" title="View">üëÅÔ∏è</button>
              <button class="action-btn action-btn-delete" onclick="deleteMembership(${m.id})" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    async function viewMembership(id) {
      currentMembershipId = id;
      const response = await fetch(`/api/admin/memberships/${id}`);
      const m = await response.json();

      document.getElementById('membership-detail-content').innerHTML = `
        <div class="membership-detail">
          <h4>üë§ Applicant Information</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Full Name</label><p>${m.full_name}</p></div>
            <div class="detail-item"><label>Email</label><p>${m.email}</p></div>
            <div class="detail-item"><label>Type</label><p style="text-transform:capitalize">${m.applicant_type}</p></div>
            <div class="detail-item"><label>Membership</label><p style="text-transform:capitalize">${m.membership_type}</p></div>
            ${m.organization_name ? `<div class="detail-item"><label>Organization</label><p>${m.organization_name}</p></div>` : ''}
            <div class="detail-item"><label>Country</label><p>${m.country || '-'}</p></div>
            <div class="detail-item"><label>City</label><p>${m.city || '-'}</p></div>
            <div class="detail-item"><label>Phone</label><p>${m.phone || '-'}</p></div>
          </div>
        </div>
        <div class="membership-detail">
          <h4>üìù Additional Details</h4>
          <div class="detail-grid">
            <div class="detail-item" style="grid-column:span 2"><label>Motivation</label><p>${m.motivation || '-'}</p></div>
            <div class="detail-item" style="grid-column:span 2"><label>Experience</label><p>${m.experience || '-'}</p></div>
            <div class="detail-item"><label>Skills</label><p>${m.skills || '-'}</p></div>
            <div class="detail-item"><label>How Heard</label><p>${m.how_heard || '-'}</p></div>
            <div class="detail-item"><label>Website</label><p>${m.website ? `<a href="${m.website}" target="_blank">${m.website}</a>` : '-'}</p></div>
            <div class="detail-item"><label>Social Media</label><p>${m.social_media || '-'}</p></div>
          </div>
        </div>
        <div class="membership-detail">
          <h4>üìã Status</h4>
          <div class="detail-grid">
            <div class="detail-item"><label>Current Status</label><p><span class="status-badge ${m.status === 'approved' ? 'status-active' : m.status === 'rejected' ? 'status-inactive' : ''}" style="${m.status === 'pending' ? 'background:#fff3cd;color:#856404;' : ''}">${m.status}</span></p></div>
            <div class="detail-item"><label>Applied On</label><p>${new Date(m.created_at).toLocaleString()}</p></div>
            <div class="detail-item"><label>Agrees to MOU</label><p>${m.agrees_to_mou ? '‚úÖ Yes' : '‚ùå No'}</p></div>
          </div>
          <div class="form-group" style="margin-top:1rem">
            <label>Admin Notes</label>
            <textarea id="admin-notes" class="form-control" rows="2">${m.admin_notes || ''}</textarea>
          </div>
        </div>
      `;
      membershipModal.classList.add('show');
    }

    function closeMembershipModal() {
      membershipModal.classList.remove('show');
      currentMembershipId = null;
    }

    async function updateMembershipStatus(status) {
      if (!currentMembershipId) return;
      const admin_notes = document.getElementById('admin-notes').value;

      await fetch(`/api/admin/memberships/${currentMembershipId}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status, admin_notes })
      });

      closeMembershipModal();
      loadMemberships();
      loadMembershipStats();
      showAlert(document.getElementById('memberships-alert'), `Application ${status}!`, 'success');
    }

    function deleteMembership(id) {
      document.getElementById('delete-id').value = id;
      document.getElementById('delete-type').value = 'membership';
      deleteModal.classList.add('show');
    }

    function closeDeleteModal() { deleteModal.classList.remove('show'); }

    async function confirmDelete() {
      const id = document.getElementById('delete-id').value;
      const type = document.getElementById('delete-type').value;
      const url = type === 'partner' ? `/api/admin/partners/${id}` : `/api/admin/memberships/${id}`;
      await fetch(url, { method: 'DELETE' });
      closeDeleteModal();
      if (type === 'partner') {
        loadPartners();
        showAlert(document.getElementById('partners-alert'), 'Partner deleted!', 'success');
      } else {
        loadMemberships();
        loadMembershipStats();
        showAlert(document.getElementById('memberships-alert'), 'Application deleted!', 'success');
      }
    }

    async function performGlobalSearch(query) {
      const searchResults = document.getElementById('search-results');
      if (query.length < 2) {
        searchResults.classList.remove('show');
        return;
      }

      try {
        const response = await fetch(`/api/admin/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();

        let html = '';
        if (data.partners && data.partners.length > 0) {
          html += '<div style="padding:0.5rem 1rem;background:var(--bg-secondary);font-weight:600;font-size:0.75rem;">PARTNERS</div>';
          data.partners.forEach(p => {
            html += `<div class="search-result-item" onclick="editPartner(${p.id})">
              <span>${p.name_en} ${p.name_fa ? `(${p.name_fa})` : ''}</span>
              <span class="result-type partner">${p.partner_type}</span>
            </div>`;
          });
        }
        if (data.memberships && data.memberships.length > 0) {
          html += '<div style="padding:0.5rem 1rem;background:var(--bg-secondary);font-weight:600;font-size:0.75rem;">MEMBERSHIPS</div>';
          data.memberships.forEach(m => {
            html += `<div class="search-result-item" onclick="viewMembership(${m.id})">
              <span>${m.full_name} (${m.email})</span>
              <span class="result-type membership">${m.status}</span>
            </div>`;
          });
        }
        if (!html) html = '<div style="padding:1rem;text-align:center;color:var(--text-muted);">No results found</div>';

        searchResults.innerHTML = html;
        searchResults.classList.add('show');
      } catch (error) {}
    }

    async function handleChangePassword(e) {
      e.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        showAlert(document.getElementById('settings-alert'), 'Passwords do not match', 'error');
        return;
      }

      try {
        const response = await fetch('/api/admin/change-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ currentPassword, newPassword })
        });
        const data = await response.json();
        if (data.success) {
          showAlert(document.getElementById('settings-alert'), 'Password changed!', 'success');
          e.target.reset();
        } else {
          showAlert(document.getElementById('settings-alert'), data.message, 'error');
        }
      } catch (error) {
        showAlert(document.getElementById('settings-alert'), 'Error changing password', 'error');
      }
    }

    function showAlert(container, message, type) {
      container.innerHTML = `<div class="alert alert-${type}">${type === 'success' ? '‚úÖ' : '‚ùå'} ${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    window.editPartner = editPartner;
    window.togglePartner = togglePartner;
    window.deletePartner = deletePartner;
    window.viewMembership = viewMembership;
    window.deleteMembership = deleteMembership;
    window.searchMemberships = searchMemberships;
    window.updateMembershipStatus = updateMembershipStatus;
    window.closeMembershipModal = closeMembershipModal;
  </script>
</body>
</html>